# **一、****LBP-GIS梯度反演****攻击**

## **1. 标签重构**

在下面的梯度反演代码中，目标样品的标签默认是已知的。如果需要使用我们提出的标签重构方法，则需要设置 --pseudo-label-init from_grads 梯度反转执行的指令。

## **2. 批量大小的训练任务 （8）**

### **2.1 获取目标样本的模型梯度**

运行以下代码以获取目标样本模型梯度的检查点（模型：使用 mocov2 训练的 ResNet-50，目标样本：imagenet-train，批处理大小 8）

通过执行上述命令获取检查点，其路径为

./train/checkpoint/idtest_resnet50_moco_v2_800ep_pretrain.pth.tar_imagenet_b8_i0-checkpoint.pth.tar

### **2.2 基本梯度反演**

不要使用组一致性正则化，需要提供正则化权重 lr、TV、BN（可选）

```
python run.py --gpu 0 --exact-bn --n-seed 1 --grad-sign --input-boxed --min-grads-loss --epochs 24000 --lr 0.1046 --TV 0.0114 --BN 0.0357 --pseudo-label-init known --metric --one-to-one-similarity --GInfoR --checkpoint ./train/checkpoint/idtest_resnet50_moco_v2_800ep_pretrain.pth.tar_imagenet_b8_i0-checkpoint.pth.tar
```

### **2.3 使用超参数搜索的基本梯度反演**

超参数搜索引擎将搜索超参数 lr、TV、BN。出于演示目的，命令中的 simulation-checkpoint 可以与 checkpoint 相同（仅限测试）。请注意，路径必须使用绝对路径。

```
python run.py --gpu 0 --exact-bn --n-seed 1 --grad-sign --input-boxed --min-grads-loss --epochs 24000 --pseudo-label-init known --metric --one-to-one-similarity --GInfoR --checkpoint [E2EGI-folder/train/checkpoint/idtest_resnet50_moco_v2_800ep_pretrain.pth.tar_imagenet_b8_i0-checkpoint.pth.tar] --superparameters-search --lr-tune --TV-tune --BN-tune --simulation-checkpoint [path, generated by own data]
```

### **2.4 具有自适应梯度组合优化 （AGCO） 的梯度反演**

AGCO融合了多个组（n-seed：8）的伪样本，形成组一致性正则化，以获得全局重建更好的样本（我们的主要贡献之一）。我们可以通过 1.3 获得适当的超参数，然后执行AGCO。

```
python run.py --gpu 0 --exact-bn --grad-sign --input-boxed --min-grads-loss --epochs 24000 --lr 0.1046 --TV 0.0114 --BN 0.0357 --pseudo-label-init known --metric --one-to-one-similarity --GInfoR --checkpoint ./train/checkpoint/idtest_resnet50_moco_v2_800ep_pretrain.pth.tar_imagenet_b8_i0-checkpoint.pth.tar --MinCombine --n-seed 8
```

## **3. 批量训练任务 （256）**

### **3.1 获取目标样本的模型梯度**

这里的区别在于，要获得对应于 256 批输入样本的模型梯度，需要运行多个 （8） 个 GPU。

```
python training.py -b 256 --pretrained [mocov2-folder/moco_v2_800ep_pretrain.pth.tar] --data [imagenet-folder with train] --dist-url tcp://127.0.0.1:10011 --dist-backend nccl --multiprocessing-distributed --world-size 1 --rank 0
```

通过执行上述命令获取检查点，其路径为

./train/checkpoint/idtest_resnet50_moco_v2_800ep_pretrain.pth.tar_imagenet_b256_i0-checkpoint.pth.tar

### **3.2 分布式梯度反演**

以上 2.2 和 2.4 都可以使用分布式梯度反演（多 GPU 执行）来支持更大批量的梯度反转任务。只需删除 gpu 设置并在命令后添加相关命令： --world-size 1 --rank 0 --dist-url tcp://127.0.0.1:10034 --dist-backend nccl --multiprocessing-distributed 。例如，在 AGCO 中应用分布式梯度反演：

```
python run.py --exact-bn --grad-sign --input-boxed --min-grads-loss --epochs 24000 --lr 0.1046 --TV 0.0114 --BN 0.0357 --pseudo-label-init known --metric --one-to-one-similarity --checkpoint ./train/checkpoint/idtest_resnet50_moco_v2_800ep_pretrain.pth.tar_imagenet_b256_i0-checkpoint.pth.tar --MinCombine --n-seed 8 --world-size 1 --rank 0 --dist-url tcp://127.0.0.1:10034 --dist-backend nccl --multiprocessing-distributed
```
